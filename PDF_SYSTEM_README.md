# Система генерации PDF карт

## Что сделано

Создана полностью рабочая система генерации PDF карт помощи с:
- ✅ Автоматическим созданием PDF шаблонов
- ✅ Заполнением данных (ФИО, контакты, медицинская информация)
- ✅ Вставкой фотографий
- ✅ Генерацией и вставкой QR кодов
- ✅ Поддержкой кириллицы

## Структура файлов

```
backend/
├── fonts/
│   └── Arial.ttf                    # Шрифт с поддержкой кириллицы
├── templates/
│   ├── card-front.pdf               # Шаблон лицевой стороны
│   └── card-back.pdf                # Шаблон обратной стороны
├── utils/
│   ├── createPdfTemplates.js        # Скрипт создания шаблонов
│   └── cardPdfGenerator.js          # Генератор PDF с данными
└── routes/
    └── cards.js                     # API endpoints для PDF
```

## API Endpoints

### Скачать лицевую сторону
```
GET /api/cards/:id/pdf/front
Authorization: Bearer {token}
```

### Скачать обратную сторону
```
GET /api/cards/:id/pdf/back
Authorization: Bearer {token}
```

## Использование

### 1. Создание/обновление шаблонов

Если нужно изменить дизайн шаблонов:

```bash
cd backend
node utils/createPdfTemplates.js
```

Это создаст новые файлы `card-front.pdf` и `card-back.pdf` в папке `templates/`.

### 2. Тестирование генерации

```bash
cd backend
node test-pdf.js
```

Результат сохранится в `backend/temp/test-front.pdf` и `backend/temp/test-back.pdf`.

### 3. Скачивание через интерфейс

1. Откройте карту в личном кабинете
2. Нажмите кнопку "Скачать PDF (обе стороны)"
3. Два PDF файла скачаются автоматически

## Настройка координат

Если текст или изображения не на своих местах, отредактируйте координаты в `backend/utils/cardPdfGenerator.js`:

```javascript
// Пример для ФИО
const nameX = 143;  // X координата
y: height - 89      // Y координата (от верха)

// Пример для фото
const photoX = 24;
const photoY = height - 160;
```

**Важно:** В PDF координаты Y идут снизу вверх, поэтому используется `height - offset`.

## Изменение дизайна

Чтобы изменить дизайн карты, отредактируйте `backend/utils/createPdfTemplates.js`:

```javascript
// Пример: изменить цвет заголовка
doc.rect(0, 0, WIDTH, 40).fill('#DC2626');  // Красный
// Измените на:
doc.rect(0, 0, WIDTH, 40).fill('#2563EB');  // Синий

// Пример: изменить размер шрифта
doc.fontSize(20)  // Текущий размер
// Измените на:
doc.fontSize(24)  // Новый размер
```

После изменений запустите:
```bash
node utils/createPdfTemplates.js
```

## Добавление нового шрифта

Если нужен другой шрифт:

1. Поместите файл `.ttf` в `backend/fonts/`
2. Обновите путь в `cardPdfGenerator.js`:

```javascript
const fontPath = path.join(__dirname, '../fonts/ВашШрифт.ttf');
```

## Технические детали

### Библиотеки
- `pdf-lib` - создание и модификация PDF
- `@pdf-lib/fontkit` - поддержка кастомных шрифтов
- `pdfkit` - создание базовых шаблонов
- `qrcode` - генерация QR кодов

### Размеры карты
- Ширина: 540 пунктов
- Высота: 320 пунктов
- Соответствует стандартной кредитной карте (85.6mm x 54mm)

### Поддерживаемые форматы фото
- JPEG (.jpg, .jpeg)
- PNG (.png)

## Troubleshooting

### Проблема: Кириллица не отображается
**Решение:** Убедитесь, что файл `backend/fonts/Arial.ttf` существует и содержит кириллические символы.

### Проблема: Фото не вставляется
**Решение:** Проверьте, что файл фото существует в `backend/uploads/avatars/` и имеет правильное расширение.

### Проблема: QR код не генерируется
**Решение:** Проверьте, что библиотека `qrcode` установлена: `npm install qrcode`

### Проблема: PDF не скачивается
**Решение:** 
1. Проверьте логи сервера
2. Убедитесь, что карта сохранена (имеет ID)
3. Проверьте токен авторизации

## Дальнейшие улучшения

Возможные улучшения системы:
- Добавить выбор цветовой схемы
- Поддержка разных размеров карт
- Экспорт в другие форматы (PNG, SVG)
- Пакетная генерация нескольких карт
- Предпросмотр PDF перед скачиванием
